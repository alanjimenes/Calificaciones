<!DOCTYPE html>
<html class="dark" lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>EduSys - Generador de Boletines (MODO PRUEBA)</title>
<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<!-- PDF-Lib -->
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
<!-- Download Helper -->
<script src="https://unpkg.com/downloadjs@1.4.7/download.min.js"></script>
<!-- Fonts -->
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet"/>
<!-- Material Symbols -->
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: {
                        "display": ["Lexend", "sans-serif"],
                        "serif": ["Times New Roman", "serif"]
                    },
                    borderRadius: {"DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px"},
                },
            },
        }
    </script>
<style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #111a22; }
        ::-webkit-scrollbar-thumb { background: #233648; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #324d67; }
        
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        .test-badge {
            background: repeating-linear-gradient(45deg, #f59e0b, #f59e0b 10px, #d97706 10px, #d97706 20px);
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-white overflow-hidden h-screen flex flex-col">
<!-- Barra Superior -->
<header class="flex flex-shrink-0 items-center justify-between border-b border-solid border-b-[#233648] bg-[#111a22] px-6 py-3 z-20 relative shadow-sm">
    <div class="flex items-center gap-4 text-white">
        <div class="size-8 flex items-center justify-center text-primary">
            <span class="material-symbols-outlined" style="font-size: 32px;">school</span>
        </div>
        <div>
            <h2 class="text-white text-xl font-bold leading-tight tracking-[-0.015em]">EduSys</h2>
            <span class="text-[10px] text-orange-400 font-bold uppercase tracking-widest">Entorno de Pruebas</span>
        </div>
    </div>
    <div class="flex items-center gap-3">
        <button onclick="fillRandomGrades()" class="flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-bold bg-orange-500/10 text-orange-400 border border-orange-500/20 hover:bg-orange-500/20 transition-all">
            <span class="material-symbols-outlined text-[18px]">casino</span>
            Notas Aleatorias
        </button>
        <button onclick="clearGrades()" class="flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-bold bg-red-500/10 text-red-400 border border-red-500/20 hover:bg-red-500/20 transition-all">
            <span class="material-symbols-outlined text-[18px]">delete_sweep</span>
            Limpiar
        </button>
    </div>
</header>

<main class="flex flex-1 overflow-hidden">
    <!-- Barra Lateral -->
    <aside class="w-full max-w-[300px] flex flex-col bg-[#111a22] border-r border-[#233648] h-full flex-shrink-0 z-10">
        <div class="p-4 border-b border-[#233648]">
            <h3 class="text-white text-lg font-bold">Pilotos de Prueba</h3>
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-3">
            <div class="relative flex items-center gap-3 p-3 bg-primary/20 border-l-4 border-primary cursor-pointer" onclick="selectStudent('Alumno de Prueba A', '2023-TEST-01')">
                <div class="bg-slate-700 rounded-full h-10 w-10 flex-shrink-0 flex items-center justify-center font-bold">A</div>
                <div class="flex flex-col flex-1 min-w-0">
                    <p class="text-white text-sm font-medium truncate">Alumno de Prueba A</p>
                    <p class="text-primary text-xs truncate">ID: 2023-TEST-01</p>
                </div>
            </div>
            <div class="relative flex items-center gap-3 p-3 border-l-4 border-transparent hover:bg-[#1f2d3b] cursor-pointer" onclick="selectStudent('Alumno de Prueba B', '2023-TEST-02')">
                <div class="bg-slate-700 rounded-full h-10 w-10 flex-shrink-0 flex items-center justify-center font-bold">B</div>
                <div class="flex flex-col flex-1 min-w-0">
                    <p class="text-white text-sm font-medium truncate">Alumno de Prueba B</p>
                    <p class="text-[#92adc9] text-xs truncate">ID: 2023-TEST-02</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- Panel de Edición y Generación -->
    <section class="flex flex-1 flex-col bg-[#0b1219] relative min-w-0">
        <div class="h-16 border-b border-[#233648] bg-[#111a22] flex items-center justify-between px-6 flex-shrink-0 z-10">
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-[#192633] border border-[#324d67]">
                    <span id="statusIcon" class="material-symbols-outlined text-[18px] text-yellow-500">pending</span>
                    <span id="templateStatus" class="text-xs font-bold text-[#92adc9]">Esperando PDF...</span>
                </div>
                <label id="manualUploadBtn" class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-blue-600/20 text-blue-400 hover:bg-blue-600/30 cursor-pointer border border-blue-600/30 transition-all">
                    <span class="material-symbols-outlined text-[18px]">upload_file</span>
                    <span class="text-xs font-bold uppercase">Cargar Plantilla PDF</span>
                    <input type="file" id="templateInput" accept="application/pdf" class="hidden" onchange="loadTemplateManual()">
                </label>
            </div>
            <button onclick="fillPDF()" id="generateBtn" class="flex items-center gap-2 px-6 py-2 rounded-lg text-sm font-bold text-white bg-primary hover:bg-blue-600 transition-all disabled:opacity-50 shadow-lg shadow-blue-500/20" disabled>
                <span class="material-symbols-outlined">picture_as_pdf</span>
                GENERAR Y VERIFICAR
            </button>
        </div>
        
        <div class="flex-1 overflow-auto p-8 flex flex-col items-center bg-neutral-900/50">
            <div class="bg-white text-black shadow-2xl w-full max-w-[850px] p-10 flex flex-col gap-6 font-serif">
                <div class="flex justify-between items-center border-b-2 border-black pb-4">
                    <div>
                        <h1 class="text-xl font-bold uppercase">Consola de Pruebas de Datos</h1>
                        <p class="text-[10px] text-gray-500">Verifica que los números caigan en el cuadro correcto del PDF</p>
                    </div>
                    <div class="test-badge px-3 py-1 text-white text-[10px] font-black italic rounded transform rotate-3">TEST MODE</div>
                </div>
                
                <div class="grid grid-cols-2 gap-4 border border-black p-4 bg-gray-50">
                    <p><strong>Estudiante:</strong> <span id="previewName" class="border-b border-black px-2">Alumno de Prueba A</span></p>
                    <p><strong>ID:</strong> <span id="previewID" class="border-b border-black px-2">2023-TEST-01</span></p>
                </div>

                <table class="w-full border-collapse border border-black text-[11px] mt-4">
                    <thead>
                        <tr class="bg-gray-200">
                            <th class="border border-black p-2 text-left w-[40%]">Asignatura (Eje Y)</th>
                            <th class="border border-black p-1 text-center">Compet. 1<br>(X:170)</th>
                            <th class="border border-black p-1 text-center">Compet. 2<br>(X:270)</th>
                            <th class="border border-black p-1 text-center">Compet. 3<br>(X:370)</th>
                            <th class="border border-black p-1 text-center">Compet. 4<br>(X:470)</th>
                        </tr>
                    </thead>
                    <tbody id="gradesTableBody"></tbody>
                </table>
            </div>
        </div>
    </section>
</main>

<script>
    const { PDFDocument, rgb, StandardFonts } = PDFLib;
    let templateBytes = null;
    
    const ASSET_PATH = 'assets/Boletin-de-calificaciones-6to-grado-NS_110723.pdf';

    const subjects = [
        "Lengua Española (Fila 0)", 
        "Lenguas Ext. Inglés (Fila 1)",
        "Lenguas Ext. Francés (Fila 2)",
        "Matemática (Fila 3)",
        "Ciencias Sociales (Fila 4)",
        "Ciencias Naturaleza (Fila 5)",
        "Ed. Artística (Fila 6)",
        "Ed. Física (Fila 7)",
        "Formación Humana (Fila 8)"
    ];

    function initGradesTable() {
        const tbody = document.getElementById('gradesTableBody');
        tbody.innerHTML = '';
        subjects.forEach((subject, rowIndex) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="border border-black p-2 font-bold bg-gray-50 text-[9px]">${subject}</td>
                ${[0,1,2,3].map(col => `
                    <td class="border border-black p-0">
                        <input type="number" class="grade-input w-full border-0 text-center p-2 text-[10px] focus:ring-0" 
                        data-row="${rowIndex}" data-col="${col}" value="0">
                    </td>
                `).join('')}
            `;
            tbody.appendChild(tr);
        });
    }

    function fillRandomGrades() {
        document.querySelectorAll('.grade-input').forEach(input => {
            input.value = Math.floor(Math.random() * (100 - 70 + 1)) + 70;
        });
    }

    function clearGrades() {
        document.querySelectorAll('.grade-input').forEach(input => input.value = 0);
    }

    window.addEventListener('DOMContentLoaded', async () => {
        initGradesTable();
        const statusText = document.getElementById('templateStatus');
        const statusIcon = document.getElementById('statusIcon');
        const generateBtn = document.getElementById('generateBtn');

        try {
            const response = await fetch(ASSET_PATH);
            if (!response.ok) throw new Error();
            templateBytes = await response.arrayBuffer();
            statusText.textContent = "PDF Detectado";
            statusText.className = "text-xs font-bold text-green-400";
            statusIcon.textContent = "check_circle";
            statusIcon.className = "material-symbols-outlined text-[18px] text-green-400";
            generateBtn.disabled = false;
        } catch (error) {
            statusText.textContent = "Cargar PDF para probar";
            statusIcon.textContent = "help";
        }
    });

    async function loadTemplateManual() {
        const input = document.getElementById('templateInput');
        if (input.files.length > 0) {
            templateBytes = await input.files[0].arrayBuffer();
            document.getElementById('templateStatus').textContent = "Plantilla de Prueba Cargada";
            document.getElementById('templateStatus').className = "text-xs font-bold text-blue-400";
            document.getElementById('statusIcon').textContent = "task_alt";
            document.getElementById('generateBtn').disabled = false;
        }
    }

    async function fillPDF() {
        if (!templateBytes) return alert("Primero carga un PDF");
        try {
            const pdfDoc = await PDFDocument.load(templateBytes);
            const helveticaFont = await pdfDoc.embedFont(StandardFonts.HelveticaBold);
            const pages = pdfDoc.getPages();
            const gradesPage = pages[1]; 

            const inputs = document.querySelectorAll('.grade-input');
            const X_START = 170;   
            const X_STEP = 100;    
            const Y_START = 460;   
            const Y_STEP = 25;     

            inputs.forEach(input => {
                const val = input.value || "0";
                if(val == "0") return;

                const row = parseInt(input.dataset.row);
                const col = parseInt(input.dataset.col);

                gradesPage.drawText(val, {
                    x: X_START + (col * X_STEP),
                    y: Y_START - (row * Y_STEP),
                    size: 9,
                    font: helveticaFont,
                    color: rgb(0, 0, 0),
                });
            });

            const pdfBytes = await pdfDoc.save();
            download(pdfBytes, "TEST_BOLETIN.pdf", "application/pdf");
        } catch (e) {
            alert("Error en proceso: " + e.message);
        }
    }

    function selectStudent(name, id) {
        document.getElementById('previewName').innerText = name;
        document.getElementById('previewID').innerText = id;
    }
</script>
</body>
</html>